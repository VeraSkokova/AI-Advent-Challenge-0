# üíæ –î–µ–Ω—å 10. –í–Ω–µ—à–Ω—è—è –ü–∞–º—è—Ç—å (Persistence)

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç "–ø–æ–º–Ω–∏–ª" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
*   **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** –§–∞–π–ª `chat_history.json` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
*   **–§–æ—Ä–º–∞—Ç:** JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (`List<Message>`).
*   **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `kotlinx.serialization`.

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1.  **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:**
    –í–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—ã—Ä—ã—Ö JSON-–æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç API (–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è `type`, `thought` –∏ —Ç.–¥.), –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç**, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
    *   *–ë—ã–ª–æ:* `{"role": "assistant", "text": "{\"type\": \"response\", \"text\": \"–ü—Ä–∏–≤–µ—Ç\"}"}`
    *   *–°—Ç–∞–ª–æ:* `{"role": "assistant", "text": "–ü—Ä–∏–≤–µ—Ç"}`
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞–ª —á–∏—â–µ, –ø–æ–Ω—è—Ç–Ω–µ–µ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—á–Ω–µ–µ –ø–æ —Ç–æ–∫–µ–Ω–∞–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.

2.  **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (DRY):**
    –°–æ–∑–¥–∞–Ω–∞ –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `formatResponseForHistory`, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å, –∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

3.  **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
    –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è. –ï—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è), —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:
    ```
    üìú Restored context:
       USER: –ù–∞–ø–æ–º–Ω–∏, –æ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏...
       ASSISTANT: –ú—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –æ —è–∑—ã–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ö–æ—Ç–ª–∏–Ω...
    ...

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
–ê–≥–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –æ–±–ª–∞–¥–∞–µ—Ç **–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç—å—é**. –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–π —Ç–µ–º—ã —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞, –Ω–µ —Ç–µ—Ä—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π.
